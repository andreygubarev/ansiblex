#!/bin/sh
set -eu

### variables #################################################################
GETANSIBLE_ARCH="${GETANSIBLE_ARCH:-}"
GETANSIBLE_PATH="${GETANSIBLE_PATH:-/usr/local/bin/getansible.sh}"

### pre-requisites #############################################################
if ! command -v curl > /dev/null; then
    echo "missing dependency: curl"
    exit 1
fi

if ! command -v sed > /dev/null; then
    echo "missing dependency: sed"
    exit 1
fi

if ! command -v grep > /dev/null; then
    echo "missing dependency: grep"
    exit 1
fi

if ! command -v uname > /dev/null; then
    echo "missing dependency: uname"
    exit 1
fi

if [ "$(uname)" != "Linux" ]; then
    echo "unsupported operating system: $(uname)"
    exit 1
fi

if [ -e "$GETANSIBLE_PATH" ]; then
    if [ ! -w "$GETANSIBLE_PATH" ]; then
        echo "path is not writable: $GETANSIBLE_PATH"
        exit 1
    fi
elif [ ! -w "$(dirname "$GETANSIBLE_PATH")" ]; then
    echo "path is not writable: $(dirname "$GETANSIBLE_PATH")"
    exit 1
fi

### pre-installation ##########################################################
if [ -z "$GETANSIBLE_ARCH" ]; then
    GETANSIBLE_ARCH=$(uname -m)
fi
case $GETANSIBLE_ARCH in
    x86_64)
        GETANSIBLE_ARCH="amd64"
        ;;
    aarch64|arm64)
        GETANSIBLE_ARCH="arm64"
        ;;
    *)
        echo "unsupported architecture: $GETANSIBLE_ARCH"
        exit 1
        ;;
esac

### functions #################################################################
install() {
    GITHUB_OWNER="andreygubarev"
    GITHUB_REPO="getansible"
    GITHUB_RELEASE=$(curl -s "https://api.github.com/repos/$GITHUB_OWNER/$GITHUB_REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    GITHUB_ARTIFACT="getansible-$GETANSIBLE_ARCH.sh"
    GITHUB_DOWNLOAD_URL="https://github.com/$GITHUB_OWNER/$GITHUB_REPO/releases/download/$GITHUB_RELEASE/$GITHUB_ARTIFACT"

    GETANSIBLE_PATH="${GETANSIBLE_PATH:-/usr/local/bin/getansible.sh}"
    curl -sL "$GITHUB_DOWNLOAD_URL" -o "$GETANSIBLE_PATH"
    chmod +x "$GETANSIBLE_PATH"
}

### main ######################################################################
case ${1:-} in
    install)
        install
        ;;
    *)
        install
        ;;
esac
